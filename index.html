import React, { useEffect, useMemo, useState } from "react";
import { motion } from "framer-motion";

/*
  Полный single-file React компонент для Telegram WebApp (Tailwind + Framer Motion).
  Включает пример интеграции с TON Connect (UI React) — нужно установить пакеты:

    npm install @tonconnect/ui-react @tonconnect/sdk framer-motion tailwindcss

  ВАЖНО: код использует официальные пакеты TonConnect. Перед деплоем убедитесь, что
  у вас правильные версии библиотек. Ссылки на документацию:
  - https://ton-connect.github.io/sdk/
  - https://docs.ton.org/v3/guidelines/ton-connect/

  Что реализовано:
  - Подключение TON-кошелька через TonConnect UI (если доступен в браузере/среде).
  - Отправка платежа на ваш фиксированный адрес (MANUAL_WALLET) через TonConnect sendTransaction.
  - Fallback — инструкция для ручного перевода, если кошелёк недоступен.
  - Локальный учёт «мои койны» (кредитуются 10x от суммы стейка, +100 за реферала, +50 за подписку).
    Хранится временно в localStorage — в продакшене — на серверной БД.
  - Пример реферального кода и автоматического начисления при вводе.
  - Стили, анимации и завершённый UX для WebApp.
*/

// Если хотите, поменяйте на свой адрес — все оплаты направляются на него.
const MANUAL_WALLET = "UQCAZPmfXSp7qnmwNAECen7phkySJZqvZT3qj6WtEAx30oRe";
const TELEGRAM_CHANNEL = "https://t.me/+z0kf4aAqT4pjYTJi";

const TOKENS = [
  { id: "ton", name: "Toncoin", symbol: "TON", min: 0.1 },
  { id: "usdt", name: "USDT (on TON)", symbol: "USDT", min: 1 },
  { id: "my", name: "StakeUP Coin", symbol: "SUC", min: 0 },
];

const DURATIONS = [
  { days: 4, label: "4d", apyRange: "8% - 10%" },
  { days: 10, label: "10d", apyRange: "10% - 14%" },
  { days: 30, label: "30d", apyRange: "14% - 18%" },
];

// Helpers for localStorage (mock DB)
const LS_KEYS = {
  WALLET_ADDR: "stakeup_wallet_addr",
  USER: "stakeup_user",
  STAKES: "stakeup_stakes",
  BALANCE: "stakeup_balance",
};

function readStorage(k, fallback) {
  try {
    const raw = localStorage.getItem(k);
    return raw ? JSON.parse(raw) : fallback;
  } catch (e) {
    return fallback;
  }
}
function writeStorage(k, v) {
  try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) {}
}

export default function StakeUpWebApp() {
  // Wallet and TonConnect
  const [connected, setConnected] = useState(false);
  const [address, setAddress] = useState(() => readStorage(LS_KEYS.WALLET_ADDR, null));
  const [tc, setTC] = useState(null); // TonConnect SDK instance (optional)

  // Stake UI
  const [selectedToken, setSelectedToken] = useState(TOKENS[0]);
  const [amount, setAmount] = useState(10);
  const [duration, setDuration] = useState(DURATIONS[1]);
  const [agree, setAgree] = useState(true);
  const [stage, setStage] = useState("ready");

  // User & balances
  const [user, setUser] = useState(() => readStorage(LS_KEYS.USER, { id: generateId(), referer: null, subs: false }));
  const [balance, setBalance] = useState(() => readStorage(LS_KEYS.BALANCE, { SUC: 0 }));
  const [stakes, setStakes] = useState(() => readStorage(LS_KEYS.STAKES, []));

  // UI
  const [notif, setNotif] = useState(null);

  useEffect(() => {
    writeStorage(LS_KEYS.USER, user);
  }, [user]);
  useEffect(() => { writeStorage(LS_KEYS.BALANCE, balance); }, [balance]);
  useEffect(() => { writeStorage(LS_KEYS.STAKES, stakes); }, [stakes]);
  useEffect(() => { if (address) writeStorage(LS_KEYS.WALLET_ADDR, address); }, [address]);

  // Try to auto-initialize Telegram WebApp or TonConnect UI if present.
  useEffect(() => {
    if (typeof window !== 'undefined') {
      // Telegram: expand WebApp if available
      try { window.Telegram?.WebApp?.expand?.(); } catch (e) {}
    }
  }, []);

  // Simple notification helper
  function notify(t, ms = 3500) {
    setNotif(t);
    setTimeout(() => setNotif(null), ms);
  }

  // Generate small id
  function generateId() {
    return Math.random().toString(36).slice(2, 10);
  }

  // TonConnect integration (lightweight). This example uses dynamic import of the UI kit —
  // in production add @tonconnect/ui-react and @tonconnect/sdk to package.json and import statically.
  async function connectTon() {
    try {
      // dynamic import so project still builds if not installed locally
      const { TonConnectUIProvider, useTonAddress, useTonConnectUI } = await import('@tonconnect/ui-react');
      const { TonConnect } = await import('@tonconnect/sdk');
      // create TonConnect instance
      const ton = new TonConnect({ /* manifestUrl optional */ });
      setTC(ton);

      // For simplicity: open native wallet selection via UI provider is recommended —
      // but here we'll use TonConnect directly to request connect.
      const wallets = await ton.connect();
      // ton.connect() returns the selected wallet info in some implementations.
      // We'll read activeTransport or requested accounts from the instance.
      const currentAddress = ton?.account?.address || (wallets && wallets[0]?.account) || null;

      // Many TonConnect UI integrations provide hooks for address; ensure to adapt to the version you use.
      if (currentAddress) {
        setAddress(currentAddress);
        setConnected(true);
        notify('Кошелёк подключён: ' + shortAddr(currentAddress));
      } else {
        // Some versions require a separate request via TonConnectUIProvider's open
        setConnected(true);
        notify('Кошелёк подключён (контекст).');
      }
    } catch (e) {
      console.warn('TonConnect init error', e);
      // If TonConnect not available — fallback to marking connected=false and showing manual flow
      notify('TonConnect недоступен — используйте ручный перевод или подключите поддерживаемый кошелёк');
      setConnected(false);
    }
  }

  function disconnect() {
    setConnected(false);
    setAddress(null);
    setTC(null);
    notify('Отключено');
  }

  function shortAddr(a) {
    if (!a) return '-';
    return a.slice(0,6) + '...' + a.slice(-5);
  }

  // Estimate reward (simple linear approx)
  function estimateRewards(amount, apyRange, days) {
    const parts = apyRange.replace(/%/g, '').split('-').map(p => parseFloat(p));
    const apy = (parts[0] + parts[1]) / 2;
    const daily = apy / 100 / 365;
    const rewards = amount * daily * days;
    return Number(rewards.toFixed(6));
  }

  // Main payment method using TonConnect (programmatic send). We attempt to call TonConnect SDK sendTransaction.
  // The exact call depends on @tonconnect/sdk version. This is a reasonable template — adapt if your installed
  // SDK uses a slightly different API.
  async function payWithTonConnect(amountTon) {
    if (!tc) {
      notify('TonConnect не инициализирован');
      return { ok: false };
    }
    try {
      // Prepare transaction object — simple transfer
      const messages = [
        {
          address: MANUAL_WALLET,
          amount: amountTon.toString(), // amount in decimal TON (string)
          // optional: payload comment or transferPayload
        }
      ];
      // sendTransaction is the typical name used in wrappers; if your SDK exposes a different method — adapt.
      const res = await tc.sendTransaction({ messages });
      // res usually contains transaction hash or boc
      return { ok: true, res };
    } catch (e) {
      console.error('Pay error', e);
      notify('Ошибка платежа: ' + (e.message || e));
      return { ok: false, e };
    }
  }

  // Finalize stake after payment confirmed (in prod — verify via on-chain proof/webhook)
  function finalizeStake({ tokenId, amount, duration, fromAddress }) {
    const id = generateId();
    const createdAt = Date.now();
    const apy = duration.apyRange;
    const estimated = estimateRewards(amount, apy, duration.days);
    const stake = { id, tokenId, amount, duration: duration.days, apy, estimated, createdAt, fromAddress, status: 'active' };
    const newStakes = [stake, ...stakes];
    setStakes(newStakes);

    // Credit 'my coins' — 10x of staked amount (for token not equal to SUC)
    const bonusCoins = tokenId !== 'my' ? (amount * 10) : 0;
    setBalance(prev => ({ ...prev, SUC: round((prev.SUC || 0) + bonusCoins) }));

    notify('Вклад активирован — начислены ' + bonusCoins + ' SUC');
  }

  function round(n) { return Math.round(n * 1000000) / 1000000; }

  // High-level handler when user confirms and wants to pay.
  async function handlePayAndStake() {
    if (!agree) { notify('Примите условия'); return; }
    if (!amount || amount <= 0) { notify('Введите сумму'); return; }

    setStage('paying');

    // If token is SUC (internal token), we don't need blockchain payment — just simulate
    if (selectedToken.id === 'my') {
      finalizeStake({ tokenId: 'my', amount, duration, fromAddress: address || 'manual' });
      setStage('staked');
      return;
    }

    // If TonConnect available — try programmatic payment
    if (tc) {
      // Note: amount must be string and formatted correctly for the SDK. Some SDKs expect native units (nanoton) —
      // adapt to toNano() if using @ton/ton lib.
      const amountStr = amount.toString();
      const r = await payWithTonConnect(amountStr);
      if (r.ok) {
        // In prod verify tx hash on server. Here we accept success.
        finalizeStake({ tokenId: selectedToken.id, amount, duration, fromAddress: address || 'wallet' });
        setStage('staked');
        return;
      }
    }

    // Fallback: show manual address for transfer
    setStage('manual');
    notify('Проведите ручный перевод и подтвердите ');
  }

  function confirmManualPaid() {
    // In prod: validate tx hash or check on-chain that payment received.
    finalizeStake({ tokenId: selectedToken.id, amount, duration, fromAddress: 'manual' });
    setStage('staked');
  }

  // Referral & subscription handling (mock):
  function applyReferral(code) {
    if (!code) return notify('Введите код');
    if (user.referer) return notify('Реферал уже применён');
    // In prod — validate code on server. Here simply accept any code and credit 100 SUC.
    setUser(prev => ({ ...prev, referer: code }));
    setBalance(prev => ({ ...prev, SUC: (prev.SUC || 0) + 100 }));
    notify('Реферальный бонус: +100 SUC');
  }

  function applySubscription() {
    if (user.subs) return notify('Уже есть подписка');
    setUser(prev => ({ ...prev, subs: true }));
    setBalance(prev => ({ ...prev, SUC: (prev.SUC || 0) + 50 }));
    notify('Подписка подтверждена — +50 SUC');
  }

  // Small UI helpers
  const totalSUC = balance.SUC || 0;
  const estimated = useMemo(() => estimateRewards(amount, duration.apyRange, duration.days), [amount, duration]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-[#030416] via-[#07102a] to-[#041226] text-white p-6">
      <div className="max-w-6xl mx-auto">
        <motion.header initial={{ y: -30, opacity: 0 }} animate={{ y: 0, opacity: 1 }} className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">StakeUP Rocket — Staking</h1>
            <p className="text-sm text-slate-400">Короткие депозиты TON / USDT — подключение через TonConnect</p>
          </div>

          <div className="flex items-center gap-4">
            <div className="text-right">
              <div className="text-xs text-slate-400">Баланс SUC</div>
              <div className="font-semibold">{round(totalSUC)} SUC</div>
            </div>

            {connected ? (
              <div className="flex items-center gap-3">
                <div className="text-sm text-slate-300">{shortAddr(address || 'wallet')}</div>
                <button onClick={disconnect} className="px-3 py-2 rounded-2xl bg-white/6">Отключить</button>
              </div>
            ) : (
              <div className="flex gap-2">
                <button onClick={connectTon} className="px-4 py-2 rounded-2xl bg-gradient-to-r from-indigo-500 to-purple-500 shadow-lg">Подключить TON</button>
                <button onClick={() => { setConnected(false); setAddress(null); notify('Режим ручной оплаты'); }} className="px-4 py-2 rounded-2xl bg-white/6">Ручной</button>
              </div>
            )}
          </div>
        </motion.header>

        <main className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
          <motion.section initial={{ x: -20, opacity: 0 }} animate={{ x: 0, opacity: 1 }} className="col-span-2 bg-[#071428]/50 p-6 rounded-2xl shadow-xl">
            <h2 className="text-xl font-semibold mb-4">Создать вклад</h2>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
              {TOKENS.map(t => (
                <button key={t.id} onClick={() => setSelectedToken(t)} className={`p-3 rounded-xl text-left border ${selectedToken.id === t.id ? 'border-indigo-400 bg-indigo-900/20' : 'bg-white/2 border-transparent'}`}>
                  <div className="font-medium">{t.name}</div>
                  <div className="text-xs text-slate-400">Мин: {t.min} {t.symbol}</div>
                </button>
              ))}
            </div>

            <div className="mb-4">
              <label className="text-sm text-slate-300">Сумма ({selectedToken.symbol})</label>
              <input type="number" min={0} step="any" value={amount} onChange={e => setAmount(parseFloat(e.target.value))} className="mt-2 w-full rounded-2xl bg-transparent border border-white/6 p-3" />
            </div>

            <div className="mb-4">
              <label className="text-sm text-slate-300">Срок</label>
              <div className="flex gap-3 mt-2">
                {DURATIONS.map(d => (
                  <button key={d.days} onClick={() => setDuration(d)} className={`px-3 py-2 rounded-lg ${duration.days === d.days ? 'bg-indigo-500/30' : 'bg-white/2'}`}>
                    <div className="text-sm font-medium">{d.label}</div>
                    <div className="text-xs text-slate-400">{d.apyRange} APY</div>
                  </button>
                ))}
              </div>
            </div>

            <div className="mb-4 p-4 rounded-2xl bg-gradient-to-r from-[#071428] to-[#061222] border border-white/6">
              <div className="flex justify-between items-center mb-2">
                <div className="text-xs text-slate-400">Оценка дохода</div>
                <div className="text-sm text-slate-200">APY: {duration.apyRange}</div>
              </div>
              <div className="text-2xl font-semibold">{amount} {selectedToken.symbol}</div>
              <div className="text-sm text-slate-400">Ожидаемый доход: {estimated} {selectedToken.symbol}</div>
            </div>

            <div className="flex items-start gap-3 mb-4">
              <input id="terms" type="checkbox" checked={agree} onChange={e => setAgree(e.target.checked)} />
              <label htmlFor="terms" className="text-sm text-slate-300">Я согласен с правилами. Понимаю риски.</label>
            </div>

            <div className="flex gap-3">
              <button onClick={handlePayAndStake} className="flex-1 py-3 rounded-2xl bg-gradient-to-r from-green-500 to-emerald-500 font-medium shadow-lg">Оплатить и активировать</button>
              <button onClick={() => { setAmount(0); setAgree(false); notify('Сброшено'); }} className="px-4 py-3 rounded-2xl bg-white/6">Сброс</button>
            </div>

            {/* Manual / TonConnect flows */}
            {stage === 'manual' && (
              <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="mt-5 p-4 rounded-xl bg-[#071428]/30 border border-white/6">
                <div className="text-sm text-slate-300 mb-2">Переведите сумму на этот адрес вручную:</div>
                <div className="p-3 bg-black/40 rounded break-words font-mono">{MANUAL_WALLET}</div>
                <div className="mt-3 flex gap-3">
                  <button onClick={confirmManualPaid} className="px-4 py-2 rounded-2xl bg-green-500">Я оплатил — подтвердить</button>
                  <button onClick={() => setStage('ready')} className="px-4 py-2 rounded-2xl bg-white/6">Отмена</button>
                </div>
              </motion.div>
            )}

            {stage === 'staked' && (
              <motion.div initial={{ scale: 0.98, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="mt-5 p-4 rounded-2xl bg-gradient-to-r from-[#04202d] to-[#041722] border border-white/6">
                <div className="text-lg font-semibold">Вклад активирован</div>
                <div className="text-sm text-slate-400">Сумма: {amount} {selectedToken.symbol}</div>
                <div className="text-sm text-slate-400">Срок: {duration.label}</div>
                <div className="mt-3">
                  <button onClick={() => { setStage('ready'); setAmount(0); notify('Готово'); }} className="px-4 py-2 rounded-2xl bg-indigo-500">Создать новый вклад</button>
                </div>
              </motion.div>
            )}

          </motion.section>

          <motion.aside initial={{ x: 20, opacity: 0 }} animate={{ x: 0, opacity: 1 }} className="col-span-1">
            <div className="p-4 rounded-2xl bg-[#071428]/60 border border-white/6 mb-4">
              <h3 className="font-semibold">Статус</h3>
              <div className="text-sm text-slate-400 mt-2">{stage === 'ready' ? 'Готов к оплате' : stage === 'paying' ? 'Идёт оплата...' : stage === 'manual' ? 'Ожидание ручного платежа' : 'Вклад активен'}</div>
            </div>

            <div className="p-4 rounded-2xl bg-[#071428]/60 border border-white/6 mb-4">
              <h3 className="font-semibold">Анимация</h3>
              <div className="mt-3 flex justify-center">
                <motion.div animate={{ rotate: 360 }} transition={{ repeat: Infinity, duration: 8 }} className="w-28 h-28 rounded-full bg-gradient-to-br from-indigo-500 to-pink-500/60 flex items-center justify-center shadow-2xl">
                  <div className="text-sm font-bold">ROCKET</div>
                </motion.div>
              </div>
            </div>

            <div className="p-4 rounded-2xl bg-[#071428]/60 border border-white/6 mb-4">
              <h3 className="font-semibold">Рефералы / Подписка</h3>
              <div className="text-sm text-slate-400 mt-2">Код реферального партнёра</div>
              <div className="flex gap-2 mt-2">
                <input className="flex-1 rounded p-2 bg-transparent border border-white/6" placeholder="Код (например: 4n6k)" id="refCode" />
                <button onClick={() => applyReferral((document.getElementById('refCode')||{}).value)} className="px-3 rounded bg-indigo-500">Применить</button>
              </div>
              <div className="mt-3">
                <button onClick={applySubscription} className="w-full px-3 py-2 rounded bg-emerald-500">Подтвердить подписку на канал</button>
                <a className="block mt-2 text-xs text-slate-400" href={TELEGRAM_CHANNEL} target="_blank" rel="noreferrer">Перейти в канал и подписаться</a>
              </div>
            </div>

            <div className="p-4 rounded-2xl bg-[#071428]/60 border border-white/6">
              <h3 className="font-semibold">История</h3>
              <div className="mt-2 text-sm text-slate-400">Последние вклады</div>
              <ul className="mt-3 space-y-2">
                {stakes.slice(0,5).map(s => (
                  <li key={s.id} className="text-sm bg-white/3 p-2 rounded flex justify-between">
                    <div>{s.amount} {s.tokenId.toUpperCase()}</div>
                    <div className="text-xs text-slate-300">{s.duration}d</div>
                  </li>
                ))}
                {stakes.length===0 && <li className="text-sm text-slate-400">История пуста</li>}
              </ul>
            </div>
          </motion.aside>
        </main>

        <footer className="mt-8 text-center text-xs text-slate-500">StakeUP Rocket — демонстрация. Для продакшена: серверная проверка транзакций и безопасность.</footer>
      </div>

      {notif && (<div className="fixed left-1/2 -translate-x-1/2 bottom-8 bg-indigo-600/90 px-4 py-2 rounded-2xl shadow-lg">{notif}</div>)}
    </div>
  );
}
